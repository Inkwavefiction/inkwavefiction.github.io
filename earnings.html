<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inkwave - Financial Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Poppins:wght@400;500;600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f8f7;
      --text: #1e1e1e;
      --muted: #6a6a6a;
      --accent: #4f8dc0;
      --white: #ffffff;
      --border: #e0e0e0;
      --sidebar-bg: #111;
      --container-bg: #ffffff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      display: flex;
      min-height: 100vh;
    }
    /* Original Sidebar */
    .sidebar {
      width: 300px;
      background: var(--sidebar-bg);
      color: var(--white);
      padding: 2rem 1.5rem;
      height: 100vh;
      position: fixed;
      overflow-y: auto;
    }
    .sidebar h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      margin-bottom: 2rem;
      font-weight: 600;
    }
    .sidebar .section { margin-bottom: 2rem; }
    .section-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #aaa;
      margin-bottom: 0.6rem;
      font-weight: 600;
    }
    .nav-link {
      display: block;
      margin: 0.5rem 0;
      color: #e0e0e0;
      text-decoration: none;
      font-size: 1rem;
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      font-weight: 500;
      transition: background 0.2s;
    }
    .nav-link:hover { background-color: #1e1e1e; }
    /* Main Content Area */
    .main {
      margin-left: 300px;
      padding: 2.5rem;
      flex: 1;
    }
    .header {
      text-align: center;
      padding: 20px 0;
      background: var(--accent);
      color: var(--white);
      border-radius: 6px;
      margin-bottom: 30px;
    }
    .header h1 { font-size: 2.5rem; margin: 0; }
    .header p { font-size: 1rem; margin-top: 5px; }
    .container {
      background: var(--container-bg);
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    /* Overview Paragraph */
    #overview p {
      font-size: 1rem;
      margin-bottom: 20px;
      line-height: 1.5;
    }
    /* Earnings Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    table, th, td { border: 1px solid var(--border); }
    th, td { padding: 10px; text-align: left; }
    th { background: var(--accent); color: var(--white); }
    section { margin-bottom: 2rem; }
    section h2 {
      font-family: 'Playfair Display', serif;
      color: var(--accent);
      margin-bottom: 1rem;
      border-bottom: 2px solid var(--accent);
      padding-bottom: 0.5rem;
      font-size: 1.5rem;
    }
    /* Cash Out Button */
    .cash-out-btn {
      display: inline-block;
      background: var(--accent);
      color: var(--white);
      border: none;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .cash-out-btn:hover { background: #3c7ba3; }
    .beta-note {
      margin-top: 10px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    hr {
      border: 0;
      border-top: 1px solid var(--border);
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <!-- Original Sidebar -->
  <div class="sidebar">
    <h2>Inkwave</h2>
    <div class="section">
      <div class="section-title">Core</div>
      <a href="author-dashboard.html" class="nav-link">üè† Dashboard</a>
      <a href="404.html" class="nav-link">üí∞ Earnings</a>
    </div>
    <div class="section">
      <div class="section-title">Writing Tools</div>
      <a href="blurb-generator.html" class="nav-link">üß† Blurb Generator</a>
      <a href="404.html" class="nav-link">üìù Grammar Fixer</a>
      <a href="story-templates.html" class="nav-link">üìÑ Story Templates</a>
      <a href="404.html" class="nav-link">üéõ Formatting Tools</a>
      <a href="404.html" class="nav-link">üè∑Ô∏è Genre & Tags</a>
    </div>
    <div class="section">
      <div class="section-title">Testing & Feedback</div>
      <a href="404.html" class="nav-link">üß™ A/B Testing</a>
      <a href="404.html" class="nav-link">üî• Reader Heatmap</a>
      <a href="404.html" class="nav-link">üë• Critique Exchange</a>
      <a href="404.html" class="nav-link">üì¢ Pitch to Readers</a>
    </div>
    <div class="section">
      <div class="section-title">Publishing</div>
      <a href="404.html" class="nav-link">‚úÖ Checklist</a>
      <a href="404.html" class="nav-link">üñºÔ∏è Cover Generator</a>
      <a href="404.html" class="nav-link">üì± Mobile Mode</a>
    </div>
    <div class="section">
      <div class="section-title">Productivity</div>
      <a href="404.html" class="nav-link">ü§ñ Inky Assistant</a>
      <a href="404.html" class="nav-link">üéØ Daily Challenges</a>
    </div>
  </div>
  
  <!-- Main Content Area -->
  <div class="main">
    <div class="header">
      <h1>Financial Dashboard</h1>
      <p>Your Earnings and Payouts</p>
    </div>
    <div class="container">
      <!-- Overview Paragraph -->
      <section id="overview">
        <p>We believe in rewarding storytellers fairly‚Äîand that means sharing a meaningful portion of our monthly revenue with the authors who power the platform. Each month, a dedicated payout pool is distributed to stories based on performance, so the more views your story earns, the more you take home. Our tiered system ensures that top-performing stories get the biggest rewards, while even newer or smaller stories still earn based on their readership. As our subscriber base and income grow, so does the size of the payout pool‚Äîgiving you the chance to earn more every single month. It‚Äôs a model built to scale with your success.</p>
      </section>
      
      <!-- Earnings Summary Section -->
      <section id="earnings-summary">
        <h2>Your Earnings</h2>
        <table>
          <thead>
            <tr>
              <th>Story Title</th>
              <th>Reads</th>
              <th>Earnings</th>
            </tr>
          </thead>
          <tbody id="storiesTableBody">
            <!-- Rows injected dynamically -->
          </tbody>
        </table>
        <p id="totalBalance"><strong>Total Balance:</strong> $0.00</p>
      </section>
      
      <!-- Cash Out Section -->
      <section id="cash-out">
        <h2>Cash Out</h2>
        <button id="cashOutBtn" class="cash-out-btn">Cash Out</button>
        <p class="beta-note">
          Note: This platform is currently in beta testing. No funds will be exchanged until the platform goes live.
        </p>
      </section>
    </div>
  </div>
  
  <!-- Firebase & Dashboard Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getFirestore, collectionGroup, getDocs } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyAJRW3QHNYAucAn0XJEN-w7CJfOAa0NzIE",
      authDomain: "inkwave-549c0.firebaseapp.com",
      projectId: "inkwave-549c0",
      storageBucket: "inkwave-549c0.appspot.com",
      messagingSenderId: "1084811926133",
      appId: "1:1084811926133:web:dummyAppId" // Replace dummyAppId with your actual App ID if available
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Load published stories from all "stories" subcollections under "users"
    async function loadPublishedStories() {
      const stories = [];
      try {
        // Use collectionGroup to fetch from all subcollections named "stories"
        const querySnapshot = await getDocs(collectionGroup(db, "stories"));
        querySnapshot.forEach(doc => {
          const data = doc.data();
          // Try to use 'reads' first, then 'views'; fallback to 0.
          const readCount = data.reads || data.views || 0;
          stories.push({ title: data.title, reads: readCount, payout: 0 });
        });
      } catch (error) {
        console.error("Error fetching stories:", error);
      }
      return stories;
    }
    
    // Tier logic: adjust these ranges and percentages as needed.
    async function updateDashboard() {
      const publishedStories = await loadPublishedStories();
      
      // Revenue parameters (replace with your actual numbers)
      const totalRevenue = 1000; // Total monthly revenue in dollars
      const payoutPercentage = 0.20; // 20% of revenue allocated for payouts
      const payoutPool = totalRevenue * payoutPercentage;
      
      // Define tiers:
      // Tier 1: 91‚Äì100+ reads, Tier 2: 81‚Äì90 reads, Tier 3: 71‚Äì80 reads, Tier 4: 61‚Äì70 reads, Open Tier: 1‚Äì60 reads.
      const tiers = [
        { name: "Tier 1", min: 91, max: Infinity, percentage: 0.30, type: "equal", maxStories: 10 },
        { name: "Tier 2", min: 81, max: 90, percentage: 0.25, type: "equal", maxStories: 10 },
        { name: "Tier 3", min: 71, max: 80, percentage: 0.15, type: "equal", maxStories: 10 },
        { name: "Tier 4", min: 61, max: 70, percentage: 0.10, type: "equal", maxStories: 10 },
        { name: "Open Tier", min: 1, max: 60, percentage: 0.20, type: "proportional" }
      ];
      
      // Initialize payouts
      publishedStories.forEach(story => { story.payout = 0; });
      
      // Calculate payouts for each tier
      tiers.forEach(tier => {
        let storiesInTier = publishedStories.filter(story => story.reads >= tier.min && story.reads <= tier.max);
        if (tier.type === "equal" && storiesInTier.length > 0) {
          // Sort descending by reads and limit to maxStories if needed
          storiesInTier.sort((a, b) => b.reads - a.reads);
          if (tier.maxStories && storiesInTier.length > tier.maxStories) {
            storiesInTier = storiesInTier.slice(0, tier.maxStories);
          }
          const share = (payoutPool * tier.percentage) / storiesInTier.length;
          storiesInTier.forEach(story => { story.payout = share; });
        } else if (tier.type === "proportional" && storiesInTier.length > 0) {
          const totalReadsInTier = storiesInTier.reduce((sum, story) => sum + story.reads, 0);
          storiesInTier.forEach(story => {
            story.payout = totalReadsInTier > 0 ? (story.reads / totalReadsInTier) * (payoutPool * tier.percentage) : 0;
          });
        }
      });
      
      // Update earnings table
      const tbody = document.getElementById("storiesTableBody");
      tbody.innerHTML = "";
      let totalBalance = 0;
      if (publishedStories.length === 0) {
        tbody.innerHTML = "<tr><td colspan='3'>No published stories found.</td></tr>";
      } else {
        publishedStories.forEach(story => {
          totalBalance += story.payout;
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${story.title}</td>
                          <td>${story.reads}</td>
                          <td>$${story.payout.toFixed(2)}</td>`;
          tbody.appendChild(tr);
        });
      }
      document.getElementById("totalBalance").innerHTML = `<strong>Total Balance:</strong> $${totalBalance.toFixed(2)}`;
    }
    
    updateDashboard();
    
    // Cash Out button functionality (beta mode)
    document.getElementById("cashOutBtn").addEventListener("click", function() {
      alert("Cash Out functionality is currently in beta. No funds will be exchanged at this time.");
    });
  </script>
</body>
</html>
