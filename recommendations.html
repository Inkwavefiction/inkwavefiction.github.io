<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recommended Stories - Reader Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Poppins&display=swap" rel="stylesheet">
  <style>
    /* Basic styling to match your reader dashboard aesthetic */
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: #fafafa;
      color: #222;
    }
    header, footer {
      background-color: #789a91;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    main {
      max-width: 800px;
      margin: 2rem auto;
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    h2 {
      color: #789a91;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    .recommendation-list {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .recommendation {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      width: calc(50% - 1rem);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .recommendation:hover {
      transform: scale(1.02);
    }
    .recommendation h3 {
      margin-top: 0;
      font-size: 1.2rem;
      color: #789a91;
    }
    .recommendation p {
      font-size: 0.9rem;
      color: #555;
    }
    .recommendation a {
      display: inline-block;
      margin-top: 0.5rem;
      text-decoration: none;
      color: #789a91;
      font-weight: bold;
    }
    .loading {
      text-align: center;
      padding: 2rem;
    }
    .back-link {
      margin-top: 1rem;
      display: block;
      text-align: center;
      color: #789a91;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <h1>Reader Dashboard - Recommended Stories</h1>
  </header>
  <main>
    <div id="recommendedStoriesContainer">
      <h2>Recommended For You</h2>
      <div id="recommendedStoriesList" class="recommendation-list">
        <div class="loading">Loading recommendations...</div>
      </div>
    </div>
    <a href="dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
  </main>
  <footer>
    <p>&copy; 2025 YourSiteName. All rights reserved.</p>
  </footer>

  <script>
    // Initialize Firebase using your configuration.
    const firebaseConfig = {
      apiKey: "AIzaSyAJRW3QHNYAucAn0XJEN-w7CJfOAa0NzIE",
      authDomain: "inkwave-549c0.firebaseapp.com",
      projectId: "inkwave-549c0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;

    // Function to load recommended stories based on the user's reading history.
    async function loadRecommendedStories() {
      const recListEl = document.getElementById("recommendedStoriesList");
      recListEl.innerHTML = '<div class="loading">Loading recommendations...</div>';
      try {
        // 1. Get the last 10 stories read by the user.
        const historySnap = await db
          .collection("users")
          .doc(currentUser.uid)
          .collection("history")
          .orderBy("timestamp", "desc")
          .limit(10)
          .get();
          
        if (historySnap.empty) {
          recListEl.innerHTML = "<p>No reading history available for recommendations.</p>";
          return;
        }
        
        // Collect the story IDs from the reading history.
        const readStoryIds = [];
        let allTags = [];
        historySnap.forEach(doc => {
          const data = doc.data();
          if(data.storyId) {
            readStoryIds.push(data.storyId);
          }
        });
        
        // 2. For each read story, retrieve its tags.
        for (const storyId of readStoryIds) {
          const storyQuery = await db.collectionGroup("stories")
            .where("id", "==", storyId)
            .get();
          if (!storyQuery.empty) {
            const storyData = storyQuery.docs[0].data();
            if(storyData.tags && Array.isArray(storyData.tags)) {
              allTags = allTags.concat(storyData.tags);
            }
          }
        }
        
        // Deduplicate the tags.
        const uniqueTags = [...new Set(allTags)];
        if (uniqueTags.length === 0) {
          recListEl.innerHTML = "<p>No tags available from your reading history for recommendations.</p>";
          return;
        }
        
        // Limit the tags to 10 (Firestore's array-contains-any supports up to 10).
        const queryTags = uniqueTags.slice(0, 10);
        
        // 3. Query published stories that have any of these tags.
        const recommendedSnap = await db.collectionGroup("stories")
          .where("status", "==", "published")
          .where("tags", "array-contains-any", queryTags)
          .limit(10)
          .get();
        
        const recommendations = [];
        recommendedSnap.forEach(doc => {
          const story = doc.data();
          // Exclude stories that have already been read.
          if (!readStoryIds.includes(story.id)) {
            recommendations.push(story);
          }
        });
        
        // Render the recommendations.
        renderRecommendedStories(recommendations);
        
      } catch (err) {
        console.error("Error loading recommended stories:", err);
        recListEl.innerHTML = "<p>Error loading recommendations.</p>";
      }
    }
    
    // Function to render the recommended stories.
    function renderRecommendedStories(stories) {
      const recListEl = document.getElementById("recommendedStoriesList");
      recListEl.innerHTML = "";
      
      if (stories.length === 0) {
        recListEl.innerHTML = "<p>No recommendations available at this time.</p>";
        return;
      }
      
      stories.forEach(story => {
        const storyEl = document.createElement("div");
        storyEl.className = "recommendation";
        storyEl.innerHTML = `
          <h3>${story.title}</h3>
          <p>${story.blurb || ""}</p>
          <a href="story.html?storyId=${story.id}">Read More</a>
        `;
        recListEl.appendChild(storyEl);
      });
    }
    
    // Listen for authentication state changes.
    auth.onAuthStateChanged(user => {
      if (!user) {
        // Redirect to login if the user is not signed in.
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      // Load the recommendations.
      loadRecommendedStories();
    });
  </script>
</body>
</html>
